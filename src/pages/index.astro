---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import ArticleCard from '../components/ArticleCard.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../consts';

// Fetch and Sort Posts
const allPosts = (await getCollection('blog')).sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// 1. Hero Post (The absolute newest)
const heroPost = allPosts[0];

// 2. Filter by Category (taking top 3 excluding the hero if needed, but usually just top 3 is fine)
// Note: We include the hero in the category list if it matches, to ensure the category list feels "fresh"
const softwarePosts = allPosts.filter((p) => p.data.category === 'software').slice(0, 3);
const gamesPosts = allPosts.filter((p) => p.data.category === 'games').slice(0, 3);
const techPosts = allPosts.filter((p) => p.data.category === 'tech').slice(0, 3);

const categories = [
  { title: 'Software Development', slug: 'software', posts: softwarePosts },
  { title: 'Video Games', slug: 'games', posts: gamesPosts },
  { title: 'Tech & Gear', slug: 'tech', posts: techPosts },
];
---

<BaseLayout title={SITE_TITLE} description={SITE_DESCRIPTION}>
  <div class="mx-auto max-w-7xl space-y-20 px-4 py-12 sm:px-6 lg:px-8">
    <!-- Welcome Header & Global RSS -->
    <div
      class="flex flex-col justify-between gap-4 border-b border-gray-200 pb-6 dark:border-gray-800 md:flex-row md:items-end"
    >
      <div>
        <h1 class="font-mono text-4xl font-bold text-text-main">
          {SITE_TITLE}
        </h1>
        <p class="mt-4 font-sans text-lg text-text-muted">
          {SITE_DESCRIPTION}
        </p>
      </div>

      <a
        href="/rss.xml"
        class="hover:bg-primary/10 inline-flex items-center gap-2 rounded-md bg-gray-100 px-3 py-1.5 font-mono text-sm font-bold text-text-muted transition-colors hover:text-primary dark:bg-gray-800"
      >
        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 5c7.18 0 13 5.82 13 13M6 11a7 7 0 017 7m-6 0a1 1 0 11-2 0 1 1 0 012 0z"></path>
        </svg>
        <span>Global RSS</span>
      </a>
    </div>

    <!-- Hero Section -->
    {
      heroPost && (
        <section class="space-y-6">
          <div class="flex items-center gap-2">
            <span class="h-8 w-1 rounded-full bg-primary" />
            <h2 class="font-mono text-2xl font-bold uppercase tracking-wider text-text-main">
              Latest Drop
            </h2>
          </div>
          <ArticleCard post={heroPost} large={true} />
        </section>
      )
    }

    <!-- Category Sections -->
    {
      categories.map(
        (cat) =>
          cat.posts.length > 0 && (
            <section class="space-y-8">
              <div class="flex items-end justify-between border-b border-gray-200 pb-4 dark:border-gray-800">
                <h2 class="font-mono text-3xl font-bold text-text-main">{cat.title}</h2>
                <a
                  href={`/category/${cat.slug}`}
                  class="group flex items-center gap-2 font-mono text-sm font-bold text-secondary transition-colors hover:text-primary"
                >
                  View All {cat.title}
                  <span class="transition-transform group-hover:translate-x-1">â†’</span>
                </a>
              </div>

              <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
                {cat.posts.map((post) => (
                  <ArticleCard post={post} />
                ))}
              </div>
            </section>
          )
      )
    }
  </div>
</BaseLayout>
