---
import BaseHead from '../components/BaseHead.astro';
import CookieBanner from '../components/CookieBanner.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { STORAGE_KEYS } from '../utils/storageUtils';

type Props = {
  title: string;
  description: string;
  image?: string;
  type?: 'website' | 'article';
  publishDate?: Date;
  ignoreIndex?: boolean; // New prop to exclude page from Pagefind indexing
};

const { title, description, image, type, publishDate, ignoreIndex = false } = Astro.props;
---

<!doctype html>
<html lang="en" class="scroll-smooth">
  <head>
    <BaseHead
      title={title}
      description={description}
      image={image}
      type={type}
      publishDate={publishDate}
    />
    <!-- 
            Script to prevent FOUC (Flash of Unstyled Content) for Theme.
            We use define:vars to inject the storage key from our utility, 
            keeping the script inline for blocking execution.
        -->
    <script is:inline define:vars={{ themeKey: STORAGE_KEYS.THEME }}>
      const stored = typeof localStorage !== 'undefined' ? localStorage.getItem(themeKey) : null;
      const system = window.matchMedia('(prefers-color-scheme: dark)').matches;

      // Use stored preference if available, otherwise fall back to system preference
      // Note: The 'setLocalStorage' utility ensures the 'theme' key is only present
      // if functional consent was granted.
      if (stored === 'dark' || (!stored && system)) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    </script>
  </head>
  <body
    class="flex min-h-screen flex-col bg-bg-main text-text-main antialiased"
    data-pagefind-ignore={ignoreIndex ? 'true' : undefined}
  >
    <Header />

    <main class="w-full flex-grow">
      <slot />
    </main>

    <Footer />
    <CookieBanner />
  </body>
</html>
